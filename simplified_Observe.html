<html>
    <head>
        <meta http-equiv="content-type" content="text/html;charset=UTF-8" />
        <meta charset="utf-8" />
        <title>JavaScript Sample Runner</title>
        
        <script type="text/javascript" charset="utf-8" src="bower_components/jquery/dist/jquery.js"></script>
        <script type="text/javascript" charset="utf-8" src="bower_components/mojio-js/dist/browser/MojioClient.js"></script>
        
        <script type="text/javascript">
            var scripts = '<script type="text/javascript" charset="utf-8" src="bower_components/jquery/dist/jquery.js"><\/script>' +
            '<script type="text/javascript" charset="utf-8" src="bower_components/mojio-js/dist/browser/MojioClient.js"><\/script>' +
            '<script type="text/javascript" charset="utf-8" src="bower_components/signalr/jquery.signalR-2.0.2.js"><\/script>';

            function init() {
                var iframe = document.getElementById("runningArea");
                var doc = iframe.contentDocument || iframe.contentWindow.document;
                var html = 'Write you code in the textarea and run the code to see the result here.';
                
                doc.open();
                doc.write(html);
                doc.close();
            }
            
            function insert_code(obj) {
                var obj = '<style>' + document.getElementById("userCSS").value + '<\/style>';
                obj += document.getElementById("userHtml").value;
                obj += '<script>' + document.getElementById("userCode").value + '<\/script>';
                
                var iframe = document.getElementById("runningArea");
                var doc = iframe.contentDocument || iframe.contentWindow.document;
                var html = '<head>' + scripts + '<\/head>' + '<body>' + obj + '<\/body>';
                
                doc.open();
                doc.writeln(html);
                doc.close();
            }
            
            window.onload = init;
        </script>
    </head>
    <body>
        <table width="100%" height="100%" border="0">
            <thead> 
                <tr height="30px">
                    <th width="50%">
                        <button onclick="insert_code()">Write your code and click me</button>
                    </th>
                    <th>Result</th>
                </tr>
            </thead>
            <tbody>
                <tr height="*">
                    <td width="50%" valign="top">
                        <textarea cols="110" rows="50" id="userCode" placeholder="js">
var MojioClient, config, mojio_client, App, Vehicle, Observer, observer;
MojioClient = this.MojioClient;

config = {
    application: '576f5522-9b0c-4f1a-82d4-4b4fbb7272bc',
    secret: '9f37148a-d431-4777-aa97-599093d72461',         // production sandbox
    hostname: 'api.moj.io',
    port: '80',
    version: 'v1'
};

mojio_client = new MojioClient(config);

var username = 'anonymous@moj.io', pwd = 'Password007', isLogin = false;
var apps = [], vehicles = [];

(function login() {
  if (!isLogin) {
    mojio_client.login(username, pwd, function(error, result) {
        if (error) {
            $("#loginResult").append("Login error: " + error);
        } else {
            isLogin = true;
            user = result;
            $("#loginResult").append('Logged in successfully<br>');
            $("#loginResult").append('UserId: ' + user.UserId + '<br>');
            $("#loginResult").append('ValidUntil: ' + user.ValidUntil + '<br>');
            App = mojio_client.model("App");
            Vehicle = mojio_client.model("Vehicle");
            Observer = mojio_client.model("Observer");
            showApps();
            showVehicles();
        }
    });
  }
}).call(this);

function showApps() {
    mojio_client.get(App, {}, function(error, result) {
        var str = "";
        if (error) {
            $("#resultDiv").html("Get Apps error: " + error);
        } else {
            var i = 0;

            if (result instanceof Array) {
                var arrlength = result.length;
                for (; i < arrlength; i++) {
                    apps[i] = new App(result[i]);
                }
            } else if (result.Data instanceof Array) {
                var arrlength = result.Data.length;
                for (; i < arrlength; i++) {
                    apps[i] = new App(result.Data[i]);
                }
            } else if ((result.Data != null)) {
                apps[i] = new App(result.Data);
            } else {
                apps[i] = new App(result);
            }

            // display the app results
            $("#resultDiv").empty();
            if (i > 0) {
                $("#resultDiv").html("<p>App list - select one and press 'Listen' for updates.</p>");
                showItems(apps, "mySelect", "app");
            } else {
                $("#resultDiv").html("<p>App list - No App found</p>");
            }
        }
    });
}

function showVehicles() {
    mojio_client.get(Vehicle, {}, function(error, result) {
        if (error) {
            $("#resultDiv2").html("Get Vehicle error: " + error);
        } else {
            var i = 0;

            if (result instanceof Array) {
                var arrlength = result.length;
                for (; i < arrlength; i++) {
                    vehicles[i] = new Vehicle(result[i]);
                }
            } else if (result.Data instanceof Array) {
                var arrlength = result.Data.length;
                for (; i < arrlength; i++) {
                    vehicles[i] = new Vehicle(result.Data[i]);
                }
            } else if ((result.Data != null)) {
                vehicles[i] = new Vehicle(result.Data);
            } else {
                vehicles[i] = new Vehicle(result);
            }

            // display the vehicles in a listbox
            $("#resultDiv2").empty();
            if (i > 0) {
                $("#resultDiv2").html("<p>Vehicle list - select one and press 'Listen' for updates.</p>");
                showItems(vehicles, "mySelect2", "vehicle");
            } else {
                $("#resultDiv2").html("<p>Vehicle list - No vehicle found</p>");
            }
        }
    });
}

function showItems(items, select, entityType) {
    var length = items.length;
    var mySelect = document.getElementById(select);
    mySelect.size = length;

    for (var i = 0; i < length; i++) {
        var option = document.createElement("option");
        option.text = items[i].Name;
        option.value = i;
        mySelect.options.add(option);
    }
}

function listenApp() {
    var list = document.getElementById("mySelect");
    var strId = "#listenAppDiv";
    var observedEntity;
    var changedCallback = function (entity) {
        $(strId).append('<p>Observed App change:</p>');
        $(strId).append(entity.Name + '<br>' + entity.Description + '<br>');
        unobserve(observedEntity, strId);
    };
    
    $(strId).empty();
    if (list.selectedIndex > -1) {
        observedEntity = new App(apps[list.selectedIndex]);
        $(strId).append('<p>Observe for the App: ' + observedEntity.Name + '</p>');
        
        mojio_client.observe(observedEntity, null, changedCallback, function(error, result) {
            if (error) {
                $(strId).append("Observe error: " + error);
            } else {
                observer = result;
                //artificial change in order to observe events
                $(strId).append("Current App Description: " + observedEntity.Description);
                observedEntity.Description = "Changed to something random [" + Math.random() + "]";
                setTimeout(function() {
                    mojio_client.put(observedEntity, function(error, result) {
                        if (error) {
                            $(strId).append("<br>App changed error: " + error);
                        } else {
                            var app = new App(result);
                            apps[list.selectedIndex] = app;
                            $(strId).append("<br>App description changed successfully to: " + app.Description);
                        }
                    });
                }, 1000);
            }
        });
    } else {
        $(strId).append("please select an item from the list first");
    }
}

function listenVehicle() {
    var list = document.getElementById("mySelect2");
    var strId = "#listenVehicleDiv";
    var observedEntity;
    var changedCallback = function (entity) {
        var vehicle, loc;
        vehicle = new Vehicle(entity);
        loc = vehicle.LastLocation;
        
        $(strId).append('<p>Received vehicle event for ' + vehicle.Name + '</p>');
        if (vehicle.IgnitionOn)
            $(strId).append('Vehicle Ignition is: On<br>');
        else
            $(strId).append('Vehicle Ignition is: Off<br>');
        $(strId).append('Last location of ' + vehicle.Name + ': Lat - ' + loc.Lat + ', Lng - ' + loc.Lng + '<br>');
    };
    
    $(strId).empty();
    if (list.selectedIndex > -1) {
        var observedEntity = new Vehicle(vehicles[list.selectedIndex]);
        $(strId).append('<p>Observe for the Vehicle: ' + observedEntity.Name + '</p>');
        
        mojio_client.observe(observedEntity, null, changedCallback, function(error, result) {
            if (error) {
                $(strId).append("Observe error: " + error);
            } else {
                observer = result;
                $(strId).append('<p>You can simulate vehicle events on the Vehicle Simulator</p>');
            }
        });
    } else {
        $(strId).append("please select an item from the list first");
    }
}
    
function unobserve(observedEntity, strId, _observer) {
    if (_observer)
        observer_default = _observer;
    else
        observer_default = observer;
        
    mojio_client.unobserve(observer_default, observedEntity, null, function(error, result) {
        if (error) {
            if (strId) {
                $(strId).append('<p>Unobserve error: ' + error + '</p>');
            } else {
                alert("Unobserve error: " + error);
            }
        } else {
            if (strId) {
                $(strId).append('<p>Unobserved the entity: ' + observedEntity.Name + '</p>');
            } else {
                console.log("Unobserved the entity: ");
                console.log(observedEntity.Name);
            }
        }
    });
}</textarea>
                        <textarea cols="110" rows="20" id="userHtml" placeholder="html">
<p> Logging in as user: anonymous@moj.io</p>
<div id="loginResult">
</div>
<hr>

<input type="button" value="Get Apps" onclick="showApps()">
<input type="button" value="Get Vehicles" onclick="showVehicles()">

<div id="resultDiv"></div>
<select id="mySelect", size="0"></select><br>
<input type="button" value="Listen" onclick="listenApp()">
<div id="listenAppDiv"></div>
<hr>

<div id="resultDiv2"></div>
<select id="mySelect2", size="0"></select><br>
<input type="button" value="Listen" onclick="listenVehicle()">
<div id="listenVehicleDiv"></div>
</textarea>
                        <textarea cols="110" rows="20" id="userCSS" placeholder="css">
body {
    background-color: #d0e4fe;
}</textarea>
                    </td>
                    <td width="50%" valign="top">
                        <iframe id="runningArea" frameborder="1" width="100%" height="100%" sandbox="allow-same-origin allow-scripts"></iframe>
                    </td>
                </tr>
            </tbody>        
        </table>
    </body>
</html>